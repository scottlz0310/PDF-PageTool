# PDF-PageTool 技術スタックアップグレード計画

## 概要
本ドキュメントは、PDF-PageToolの現在の技術スタックをレビューし、より新しく高機能な代替技術への移行計画を提示します。

---

## 現在の技術スタック

| カテゴリ | 現在の技術 | バージョン |
|---------|-----------|-----------|
| **GUIフレームワーク** | PyQt6 | 6.4.0+ |
| **PDF処理** | PyPDF2 | 3.0.0+ |
| **PDF処理（補助）** | pikepdf | 8.0.0+ |
| **PDF→画像変換** | pdf2image | 1.16.0+ |
| **画像処理** | Pillow | 9.0.0+ |
| **テーマ管理** | qt-theme-manager | 0.1.0+ |
| **ログ** | colorlog | 6.7.0+ |
| **設定管理** | カスタム実装 | - |
| **ビルドシステム** | setuptools | 61.0+ |
| **パッケージマネージャ** | uv | - |

---

## 代替技術スタックの提案

### 1. GUIフレームワーク

#### 現在: PyQt6
**代替案A: PySide6 (Qt for Python)**
- **メリット**:
  - LGPLライセンス（商用利用が容易）
  - Qt公式サポート
  - PyQt6とほぼ同じAPI
  - より活発な開発コミュニティ
- **デメリット**:
  - 移行コストは低いが、全ファイルのimport文変更が必要
  - 一部のサードパーティライブラリがPyQt6専用
- **技術的ハードル**: ★☆☆☆☆（低）
  - import文の一括置換で対応可能
  - APIの互換性が高い

**代替案B: Tkinter + CustomTkinter**
- **メリット**:
  - Python標準ライブラリ（追加インストール不要）
  - モダンなUI（CustomTkinter使用時）
  - 軽量
- **デメリット**:
  - 機能が限定的
  - 複雑なUIの実装が困難
  - ドラッグ&ドロップの実装が複雑
- **技術的ハードル**: ★★★★☆（高）
  - 全UIの再実装が必要

**代替案C: Electron + Python (Eel/PyWebView)**
- **メリット**:
  - モダンなWeb技術でUI構築
  - クロスプラットフォーム対応が容易
  - リッチなUIコンポーネント
- **デメリット**:
  - アプリサイズが大きい
  - メモリ使用量が多い
  - Python-JavaScript間の通信オーバーヘッド
- **技術的ハードル**: ★★★★★（非常に高）
  - アーキテクチャの全面的な再設計が必要

**推奨**: PySide6（ライセンスの柔軟性と移行コストのバランスが良い）

---

### 2. PDF処理ライブラリ

#### 現在: PyPDF2 + pikepdf

**代替案A: pypdf (PyPDF2の後継)**
- **メリット**:
  - PyPDF2の公式後継プロジェクト
  - より活発な開発
  - バグ修正が迅速
  - 後方互換性あり
- **デメリット**:
  - 一部のAPIが変更されている
- **技術的ハードル**: ★☆☆☆☆（非常に低）
  - import文の変更のみで対応可能
  - `from PyPDF2 import ...` → `from pypdf import ...`

**代替案B: PyMuPDF (fitz)**
- **メリット**:
  - 非常に高速（C++ベース）
  - 豊富な機能（テキスト抽出、注釈、編集）
  - 高品質なレンダリング
  - pdf2imageが不要になる（画像変換機能内蔵）
- **デメリット**:
  - AGPLライセンス（商用利用に制限）
  - APIが大きく異なる
- **技術的ハードル**: ★★★☆☆（中）
  - PDF操作ロジックの全面的な書き換えが必要
  - サムネイル生成ロジックの統合

**代替案C: pdfplumber**
- **メリット**:
  - テキスト抽出に特化
  - 表データの抽出が得意
- **デメリット**:
  - ページ操作機能が限定的
  - 本プロジェクトの用途には不向き
- **技術的ハードル**: ★★★★☆（高）

**推奨**: pypdf（短期）、PyMuPDF（長期・パフォーマンス重視の場合）

---

### 3. PDF→画像変換

#### 現在: pdf2image

**代替案A: PyMuPDF (fitz)**
- **メリット**:
  - pdf2imageより高速（3-5倍）
  - 外部依存なし（poppler不要）
  - メモリ効率が良い
  - 画質調整が柔軟
- **デメリット**:
  - AGPLライセンス
- **技術的ハードル**: ★★☆☆☆（低〜中）
  - サムネイル生成ロジックの書き換え
  - 既存のPillow統合は維持可能

**代替案B: pdf2image（現状維持）**
- **メリット**:
  - 安定している
  - シンプルなAPI
- **デメリット**:
  - poppler依存（配布が複雑）
  - パフォーマンスが劣る

**推奨**: PyMuPDF（PDF処理と統合する場合）

---

### 4. 画像処理

#### 現在: Pillow

**代替案A: Pillow-SIMD**
- **メリット**:
  - Pillowの高速版（SIMD命令使用）
  - 2-4倍高速
  - APIは完全互換
- **デメリット**:
  - コンパイルが必要（一部環境）
  - PyPIでのインストールが複雑
- **技術的ハードル**: ★★☆☆☆（低〜中）
  - requirements.txtの変更のみ
  - ビルド環境の整備が必要

**代替案B: opencv-python**
- **メリット**:
  - 高速な画像処理
  - 豊富な画像処理機能
- **デメリット**:
  - サイズが大きい
  - 本プロジェクトには過剰
- **技術的ハードル**: ★★★☆☆（中）

**推奨**: Pillow（現状維持）またはPillow-SIMD（パフォーマンス重視）

---

### 5. テーマ管理

#### 現在: qt-theme-manager + カスタム実装

**代替案A: qt-material**
- **メリット**:
  - Material Designテーマ
  - 豊富なカラーバリエーション
  - アニメーション対応
- **デメリット**:
  - カスタマイズが限定的
  - 既存テーマとの互換性なし
- **技術的ハードル**: ★★★☆☆（中）
  - テーマシステムの全面的な書き換え

**代替案B: QDarkStyleSheet**
- **メリット**:
  - シンプルで軽量
  - ダークテーマに特化
  - カスタマイズ可能
- **デメリット**:
  - ライトテーマのサポートが弱い
- **技術的ハードル**: ★★☆☆☆（低〜中）

**代替案C: PyQtDarkTheme**
- **メリット**:
  - モダンなダークテーマ
  - ライト/ダーク切り替え対応
  - 活発な開発
- **デメリット**:
  - カスタムテーマの作成が複雑
- **技術的ハードル**: ★★☆☆☆（低〜中）

**推奨**: PyQtDarkTheme（モダンなUIと機能のバランスが良い）

---

### 6. ログシステム

#### 現在: colorlog

**代替案A: structlog**
- **メリット**:
  - 構造化ログ（JSON出力対応）
  - 高度なフィルタリング
  - パフォーマンスが良い
  - 本番環境での分析に適している
- **デメリット**:
  - 設定が複雑
  - 開発時の可読性が劣る
- **技術的ハードル**: ★★☆☆☆（低〜中）
  - ロガー初期化部分の書き換え

**代替案B: loguru**
- **メリット**:
  - 非常にシンプルなAPI
  - 自動的なログローテーション
  - カラー出力対応
  - 例外トレースバックが見やすい
- **デメリット**:
  - 標準loggingとの統合が複雑
- **技術的ハードル**: ★☆☆☆☆（非常に低）
  - ロガー取得部分の書き換えのみ

**代替案C: colorlog（現状維持）**
- **メリット**:
  - 現在の実装で十分
  - 安定している
- **デメリット**:
  - 構造化ログ非対応

**推奨**: loguru（シンプルさと機能のバランスが良い）

---

### 7. 設定管理

#### 現在: カスタム実装（JSON）

**代替案A: pydantic-settings**
- **メリット**:
  - 型安全な設定管理
  - バリデーション自動化
  - 環境変数との統合
  - 複数フォーマット対応（JSON, YAML, TOML）
- **デメリット**:
  - 学習コストがある
- **技術的ハードル**: ★★★☆☆（中）
  - 設定クラスの定義が必要
  - 既存の設定ファイル移行

**代替案B: dynaconf**
- **メリット**:
  - 環境別設定管理
  - 複数フォーマット対応
  - シークレット管理
- **デメリット**:
  - 本プロジェクトには過剰
- **技術的ハードル**: ★★★☆☆（中）

**代替案C: python-dotenv + dataclasses**
- **メリット**:
  - シンプル
  - 型ヒント対応
  - 標準ライブラリ活用
- **デメリット**:
  - 機能が限定的
- **技術的ハードル**: ★★☆☆☆（低〜中）

**推奨**: pydantic-settings（型安全性と拡張性）

---

### 8. ビルドシステム

#### 現在: setuptools

**代替案A: hatchling**
- **メリット**:
  - モダンなビルドバックエンド
  - pyproject.toml完全対応
  - プラグインシステム
  - 高速
- **デメリット**:
  - 比較的新しい（エコシステムが発展途上）
- **技術的ハードル**: ★☆☆☆☆（非常に低）
  - pyproject.tomlの`build-backend`変更のみ

**代替案B: poetry**
- **メリット**:
  - 依存関係管理統合
  - 仮想環境管理
  - パッケージング簡単
- **デメリット**:
  - uvと競合する可能性
  - ロックファイルが独自形式
- **技術的ハードル**: ★★☆☆☆（低〜中）

**代替案C: flit**
- **メリット**:
  - 非常にシンプル
  - 高速
- **デメリット**:
  - 機能が限定的
- **技術的ハードル**: ★☆☆☆☆（非常に低）

**推奨**: hatchling（uvとの相性が良い）

---

### 9. テストフレームワーク

#### 現在: pytest

**代替案A: pytest + pytest-xdist（並列実行）**
- **メリット**:
  - テスト実行の高速化
  - CI/CDでの時間短縮
- **デメリット**:
  - 設定が必要
- **技術的ハードル**: ★☆☆☆☆（非常に低）
  - 依存関係追加のみ

**代替案B: pytest + hypothesis（プロパティベーステスト）**
- **メリット**:
  - より堅牢なテスト
  - エッジケースの自動発見
- **デメリット**:
  - テスト作成の学習コスト
- **技術的ハードル**: ★★☆☆☆（低〜中）

**推奨**: pytest + pytest-xdist + hypothesis（テスト品質向上）

---

### 10. 型チェック

#### 現在: mypy

**代替案A: pyright**
- **メリット**:
  - 非常に高速（Rust実装）
  - VS Code統合
  - より厳密な型チェック
- **デメリット**:
  - 一部のmypy機能が未対応
- **技術的ハードル**: ★☆☆☆☆（非常に低）
  - 設定ファイルの追加のみ

**代替案B: mypy（現状維持）**
- **メリット**:
  - 安定している
  - エコシステムが成熟
- **デメリット**:
  - 実行速度が遅い

**推奨**: pyright（パフォーマンス重視）またはmypy（現状維持）

---

### 11. 非同期処理

#### 現在: QThread

**代替案A: asyncio + qasync**
- **メリット**:
  - モダンな非同期処理
  - より効率的なリソース利用
  - 複数の非同期タスク管理が容易
- **デメリット**:
  - 学習コストが高い
  - 既存コードの大幅な書き換え
- **技術的ハードル**: ★★★★☆（高）
  - 非同期処理ロジックの全面的な書き換え

**代替案B: concurrent.futures**
- **メリット**:
  - 標準ライブラリ
  - シンプルなAPI
  - スレッドプール管理が容易
- **デメリット**:
  - QThreadとの統合が必要
- **技術的ハードル**: ★★☆☆☆（低〜中）

**推奨**: QThread（現状維持）、将来的にasyncio + qasync検討

---

## 優先度別アップグレード計画

### フェーズ1: 低リスク・高効果（即座に実施可能）

1. **pypdf への移行**
   - 期間: 1日
   - 効果: バグ修正、将来的なサポート
   - リスク: 非常に低

2. **loguru への移行**
   - 期間: 2日
   - 効果: ログの可読性向上、デバッグ効率化
   - リスク: 低

3. **pytest-xdist の追加**
   - 期間: 1日
   - 効果: テスト実行時間短縮
   - リスク: 非常に低

4. **hatchling への移行**
   - 期間: 1日
   - 効果: ビルド高速化
   - リスク: 低

### フェーズ2: 中リスク・高効果（計画的に実施）

5. **PyMuPDF への移行**
   - 期間: 1-2週間
   - 効果: パフォーマンス大幅向上、pdf2image不要
   - リスク: 中（ライセンス確認必要）

6. **pydantic-settings への移行**
   - 期間: 3-5日
   - 効果: 型安全性、設定バリデーション
   - リスク: 中

7. **PyQtDarkTheme への移行**
   - 期間: 3-5日
   - 効果: モダンなUI、メンテナンス性向上
   - リスク: 中

### フェーズ3: 高リスク・長期的効果（慎重に検討）

8. **PySide6 への移行**
   - 期間: 1-2週間
   - 効果: ライセンスの柔軟性
   - リスク: 中〜高

9. **asyncio + qasync への移行**
   - 期間: 2-4週間
   - 効果: 非同期処理の効率化
   - リスク: 高

10. **pyright の追加**
    - 期間: 2-3日
    - 効果: 型チェック高速化
    - リスク: 低

---

## 技術的負債の解消

### 現在の技術的負債

1. **カスタムテーママネージャーの複雑性**
   - 統合テーママネージャーとqt-theme-managerの併用
   - 推奨: PyQtDarkThemeへの統一

2. **サムネイル生成の非効率性**
   - pdf2image + Pillowの2段階処理
   - 推奨: PyMuPDFで統合

3. **設定管理の型安全性欠如**
   - 辞書ベースの設定管理
   - 推奨: pydantic-settings導入

4. **テストカバレッジの不足**
   - 現在のカバレッジ: 不明
   - 推奨: 80%以上を目標

---

## 推奨アップグレードロードマップ

### 短期（1-2ヶ月）
```
Week 1-2:
- pypdf移行
- loguru移行
- pytest-xdist追加
- hatchling移行

Week 3-4:
- PyMuPDF評価・PoC
- pydantic-settings設計

Week 5-8:
- PyMuPDF本格移行
- pydantic-settings実装
```

### 中期（3-6ヶ月）
```
Month 3-4:
- PyQtDarkTheme移行
- テストカバレッジ向上（80%目標）
- pyright導入

Month 5-6:
- PySide6移行検討・評価
- パフォーマンス最適化
```

### 長期（6-12ヶ月）
```
Month 7-9:
- asyncio + qasync移行検討
- アーキテクチャリファクタリング

Month 10-12:
- プラグインシステム検討
- 拡張機能開発
```

---

## まとめ

### 最優先で実施すべき項目
1. **pypdf** - 即座に移行可能、将来的なサポート確保
2. **loguru** - 開発効率向上
3. **PyMuPDF** - パフォーマンス大幅改善

### 慎重に検討すべき項目
1. **PySide6** - ライセンスメリットはあるが移行コストを考慮
2. **asyncio** - 大規模なリファクタリングが必要

### 現状維持を推奨する項目
1. **Pillow** - 安定しており十分な機能
2. **pytest** - 成熟したエコシステム
3. **QThread** - PyQt6との統合が良好

---

## 参考リンク

- [pypdf GitHub](https://github.com/py-pdf/pypdf)
- [PyMuPDF Documentation](https://pymupdf.readthedocs.io/)
- [loguru Documentation](https://loguru.readthedocs.io/)
- [pydantic-settings](https://docs.pydantic.dev/latest/concepts/pydantic_settings/)
- [PySide6 Documentation](https://doc.qt.io/qtforpython/)
- [PyQtDarkTheme](https://github.com/5yutan5/PyQtDarkTheme)
- [hatchling](https://hatch.pypa.io/)
- [pyright](https://github.com/microsoft/pyright)

---

**作成日**: 2025-01-17  
**バージョン**: 1.0  
**次回レビュー**: 2025-04-17
